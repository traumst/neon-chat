
<div class="flex flex-col h-screen">
    <script>
        function scrollToFirstChild(parent) {
            const firstElement = parent.children[0];
            firstElement?.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
        chatHeaderObserver = null;
        chatHeaderObserver = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    scrollToFirstChild(mutation.target);
                }
            });
        });
        chatHeaders = null;
        chatHeaders = document.querySelector(".chat-headers");
        if (chatHeaders) {
            chatHeaderObserverOptions = null;
            chatHeaderObserverOptions = { childList: true, subtree: true, characterData: true };
            chatHeaderObserver.observe(chatHeaders, chatHeaderObserverOptions);
        }
    </script>
    <div class="active-user default-transition
        flex flex-row justify-end
        p-2
        shadow"
    >
        {{ .ActiveUser }}&nbsp;
        <sub title="log out {{ .ActiveUser }}"
            hx-post="/logout" 
            hx-trigger="submit" 
            hx-target="body"
            class="other-info flex hover:text-amber-700"
        >
            [logout]
        </sub>
        <sub id="openSettingButton" 
            title="open settings" 
            hx-trigger="click" 
            hx-get="/settings" 
            hx-target=".open-chat" 
            hx-swap="innerHTML"
            class="other-info flex hover:text-green-700"
        >
            [settings]
        </sub>
        {{ with .OpenTemplate }}
        <!-- edge cases for: 
            1. start-in-chat =>
                close-chat => 
                open-settings => 
                close-settings => 
                opens closed chat 
            2. start-with-welcome =>
                create/open-chat => 
                open-settings =>
                close-settings => 
                opens welcome page
        -->
        <sub id="closeSettingButton" 
            title="close settings" 
            hx-trigger="click" 
            hx-get="/chat/{{.OpenTemplate.ChatId}}" 
            hx-target=".open-chat" 
            hx-swap="innerHTML"
            class="other-info hidden hover:text-amber-700"
        >
            [settings]
        </sub>
        {{ else }}
        <sub id="closeSettingButton" 
            title="close settings" 
            hx-trigger="click" 
            hx-get="/chat/welcome" 
            hx-target=".open-chat" 
            hx-swap="innerHTML"
            class="other-info hidden hover:text-amber-700"
        >
            [settings]
        </sub>
        {{ end }}
            
        <script>
            // store state to know whether to show settings or page reload
            document.getElementById('openSettingButton').addEventListener('click', (event) => {
                document.getElementById('openSettingButton').classList.remove('flex')
                document.getElementById('openSettingButton').classList.add('hidden')
                sessionStorage.setItem("settingsPanelOpen", "true");
                document.getElementById('closeSettingButton').classList.remove('hidden')
                document.getElementById('closeSettingButton').classList.add('flex')
                sessionStorage.setItem("settingsPanelClose", "false");
                console.log("settingsPanelClose", sessionStorage.getItem("settingsPanelClose"))
                console.log("settingsPanelOpen", sessionStorage.getItem("settingsPanelOpen"))
            });
            document.getElementById('closeSettingButton').addEventListener('click', (event) => {
                document.getElementById('openSettingButton').classList.remove('hidden')
                document.getElementById('openSettingButton').classList.add('flex')
                sessionStorage.setItem("settingsPanelOpen", "false");
                document.getElementById('closeSettingButton').classList.remove('flex')
                document.getElementById('closeSettingButton').classList.add('hidden')
                sessionStorage.setItem("settingsPanelClose", "true");
                console.log("settingsPanelClose", sessionStorage.getItem("settingsPanelClose"))
                console.log("settingsPanelOpen", sessionStorage.getItem("settingsPanelOpen"))
            });
        </script>
    </div>

    <div class="add-chat 
        flex w-full 
        p-2
        shadow"
    >
        <form id="add-chat-form"
            hx-post="/chat" 
            hx-trigger="submit" 
            hx-target=".open-chat" 
            hx-swap="innerHTML"
            class="w-full border-2 rounded border-emerald-400">
        <input id="newChatName" type="text" name="chatName" placeholder="new chat name" title="enter to send"
            class="w-full justify-center text-center rounded-md
                bg-gradient-to-br from-green-800 to-indigo-800
                text-gray-400
                shadow shadow-zinc-700
                hover:shadow-lg hover:shadow-zinc-500">
        <button type="submit" class="hidden">
            Create Chat
        </button>
        </form>
        <script>
            document.body.addEventListener('htmx:afterSwap', event => {
                const newChatName = document.getElementById('newChatName');
                if (newChatName) {
                    newChatName.value = '';
                }
            });
        </script>
    </div>

    <div class="chat-list default-transition 
        flex flex-col
        p-2
        mb-1
        shadow
        overflow-x-hidden
        overflow-y-auto"
    >
        <ul sse-swap="{{ .ChatAddEvent }}" 
            hx-swap="afterbegin" 
            class="chat-headers default-transition flex flex-col"
        > 
        {{ with $chats := .ReverseChats }}
            {{ range $index, $chat := $chats }} 
                {{ template "chat_li.html" $chat }}
            {{ end }}
        {{ else }}
            <li id="noChats" 
                sse-swap="{{ .ChatAddEvent }}" 
                hx-swap="delete" 
                target="#noChats" 
                class="h-7 flex flex-grow-0 px-2 py-4"
            >
                No chats yet
            </li>
        {{ end }}
        </ul>
        <script>
        function scrollToFirstChild(parent) {
            const firstElement = parent.children[0];
            firstElement?.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
        chatHeaderObserver = null;
        chatHeaderObserver = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    scrollToFirstChild(mutation.target);
                }
            });
        });
        chatHeaders = null;
        chatHeaders = document.querySelector(".chat-headers");
        if (chatHeaders) {
            chatHeaderObserverOptions = null;
            chatHeaderObserverOptions = { childList: true, subtree: true, characterData: true };
            chatHeaderObserver.observe(chatHeaders, chatHeaderObserverOptions);
        }
        scrollToFirstChild(chatHeaders);
        </script>
    </div>
<!-- <div id="left-panel-toggle">
    <button onclick="togglePanel()" 
        class="default-transition mt-auto">
    </button>
</div> -->
</div>