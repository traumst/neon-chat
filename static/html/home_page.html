<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min Chat</title>
    <link rel="icon" type="image/svg+xml" href="icon/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="icon/scarab-bnw.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap">
    {{ if .LoadLocal }}
        <script src="/script/htmx.min.1.9.12.js"></script>
        <script src="/script/htmx.sse.1.9.12.js"></script>
        <!-- Need to build tailwind to minimize it and apply custom styles -->
        <script src="/script/tailwindcss.3.4.3.js"></script>
        <link href="/css/tailwind.css" rel="stylesheet">
    {{ else }}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.12/htmx.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.12/ext/sse.min.js"></script>
        <script src="https://cdn.tailwindcss.com/3.4.3"></script>
        <link href="/css/tailwind.css" rel="stylesheet">
    {{ end }}
    <script>
        function escFocus(event) {
            if (event.key === 'Escape') {
                event.target.blur();
            } else {
                //console.log('escFocus key', event.key)
            }
        }
        function enterSubmit(event) {
            if (event.key === 'Enter') {
                event.target.submit();
            } else {
                //console.log('enterSubmit key', event.key)
            }
        }
        function togglePanel() {
            const panel = document.querySelector('.left-panel');
            const isOpen = panel.classList.contains('open');
            if (isOpen) {
                return closePanel(panel);
            }
            return openPanel(panel);

            function openPanel(panel) {
                openLeftPanel(panel);
                [...panel.children].forEach(element => {
                    openLeftPanel(element);
                    if (element.id === 'left-panel-toggle') {
                        element.innerHTML = '⇾  ⇽';
                    }
                });
                return '⇾  ⇽';
            }
            function closePanel(panel) {
                closeLeftPanel(panel);
                [...panel.children].forEach(element => {
                    closeLeftPanel(element);
                    if (element.id === 'left-panel-toggle') {
                        element.innerHTML = '⇽⇾';
                    }
                });
                return '⇽⇾';
            }
            function openLeftPanel(panel) {
                panel.classList.remove('closed');
                panel.classList.add('open');
            }
            function closeLeftPanel(panel) {
                panel.classList.remove('open');
                panel.classList.add('closed');
            }
        }
    </script>
    <style>
        body {
            font: inherit;
            font-size: .8rem;
            font-family: 'JetBrains Mono', sans-serif;
        }
        @keyframes fadeInFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-25);
                transform: translateY(13%);
            }
            50% {
                opacity: .3;
                transform: translateX(-10);
                transform: translateY(-13%);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
                transform: translateY(0);
            }
        }
        .default-transition {
            animation: fadeInFromLeft .17s ease forwards;
        }
        .left-panel.closed {
            width: 9%;
        }
        .closed .other-info {
            display: none;
        }
        .left-panel-toggle.closed::before {
            content: "⇽-⇾";
        }
        .left-panel-toggle.open::before {
            content: "⇾-⇽";
        }
        .ticker:hover {
            overflow: visible;
            animation: ticker 5s linear infinite;
            animation-iteration-count: 1;
        }
        @keyframes ticker {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-100%);
            }
        }
        ::-webkit-scrollbar {
            width: .37rem;
        }
        ::-webkit-scrollbar-track {
            background: #4338ca;
            border-width: 2px;
            border-color: #3f3f46;
            border-radius: 4px;
            box-shadow: #3f3f46;
        }
        ::-webkit-scrollbar-thumb {
            background: #166534;
            border-width: 3px;
            border-color: #3f3f46;
            border-radius: 8px;
            box-shadow: #3f3f46;
        }
    </style>
</head>
<body 
    {{ if .IsAuthorized }}
        hx-ext="sse" sse-trigger="load" sse-connect="/poll"
    {{ end }}
    class="flex flex-row justify-between
        items-center
        h-screen
        w-screen
        border-2 border-zinc-800 rounded-lg
        bg-gradient-to-br from-indigo-800 to-zinc-700
        text-gray-400
        shadow-md
        overflow-hidden">
    <div class="left-panel
        flex flex-grow flex-col
        h-screen
        w-1/3
        border-2 border-zinc-600 rounded-lg
        shadow shadow-zinc-800">
        <div class="default-transition h-screen">
            {{ if .IsAuthorized }}
                {{ template "left_panel.html" . }}
            {{ else }}
                {{ template "auth_div.html" . }}
            {{ end }}
        </div>
    </div>
    <div class="right-panel
        flex flex-grow flex-col 
        h-screen 
        w-2/3 
        border-2 border-zinc-700 rounded-lg
        shadow shadow-zinc-900">
        <div class="open-chat default-transition h-screen overflow-y-auto overflow-x-hidden">
            {{ if .IsAuthorized }}
                {{ with .OpenChat }}
                    {{ template "chat_div.html" . }}
                {{ else }}
                    {{ template "welcome_div.html" . }}
                {{ end }}
            {{ else }}
                {{ template "welcome_div.html" . }}
            {{ end }}
            {{ with .InformUser }}
                {{ template "verification_sent.html" . }}
            {{ end }}
        </div>
    </div>
    <script>
        document.body.addEventListener('htmx:beforeOnLoad', function handleServerError(event) {
            if (event.detail.xhr.status >= 400) {
                alert(`Action failed ${event.detail.xhr.status} ${event.detail.xhr.responseText}`)
                console.debug("err xhr response:", 
                    event.detail.xhr.responseText, 
                    event.detail.xhr.status, 
                    event.detail.xhr.statusText)
            }
        });
    </script>
</body>
</html>