<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min Chat</title>
    <link rel="icon" type="image/svg+xml" href="icon/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="icon/scarab-bnw.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap">
    {{ if .LoadLocal }}
    <script src="/script/htmx.1.9.10.min.js"></script>
    <script src="/script/htmx.1.9.10.sse.js"></script>
    <script src="/script/htmx.1.9.10.debug.js"></script>
    <script src="/script/tailwindcss.3.4.3.min.js"></script>
    <!-- Need to build tailwind to minimize it -->
    <!-- <link href="/css/tailwind.css" rel="stylesheet"> -->
    {{ else }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.11/htmx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.11/ext/sse.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    {{ end }}
    <style>
        body {
            font: inherit;
            font-size: .9rem;
            font-family: 'JetBrains Mono', sans-serif; /* Using Google Fonts example */
        }
        .left-panel {
            transition: all 0.3s ease;
        }
        .left-panel.closed {
            width: 9%;
        }
        .left-panel.open {
            width: 33%;
        }
        .active-user {
            transition: all 0.3s ease;
        }
        .closed .other-info {
            display: none;
        }
        .chat-list {
            transition: all 0.3s ease;
        }
        .left-panel-toggle {
            transition: all 0.3s ease;
        }
        .left-panel-toggle.closed::before {
            content: "⇽-⇾";
        }
        .left-panel-toggle.open::before {
            content: "⇾-⇽";
        }
        .ticker:hover {
            overflow: visible;
            animation: ticker 5s linear infinite;
            animation-iteration-count: 1;
        }
        @keyframes ticker {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-100%);
            }
        }
        .chat-list::-webkit-scrollbar {
            width: .37rem;
        }
        .chat-list::-webkit-scrollbar-track {
            background: #7B1FA2;
            border-width: 4px;
            border-radius: 2px;
        }
        .chat-list::-webkit-scrollbar-thumb {
            background: #388E3C;
            border-width: 4px;
            border-radius: 8px;
            box-shadow: #3f3f46;
        }
    </style>
</head>
<body 
    {{ if .IsAuthorized }}
        hx-ext="sse" sse-trigger="load" sse-connect="/poll"
    {{ end }}
    class="flex
        justify-between
        items-center
        h-screen
        w-screen
        border-2 border-zinc-800 rounded-lg
        bg-gradient-to-br from-indigo-800 to-zinc-700
        text-gray-400
        shadow-md
        overflow-hidden">
    <script>
        document.body.addEventListener('htmx:beforeOnLoad', function(event) {
            if (event.detail.xhr.status >= 400) {
                alert(`Action failed ${event.detail.xhr.status} ${event.detail.xhr.responseText}`)
                console.debug("Action failed:", 
                    event.detail.xhr.responseText, 
                    event.detail.xhr.status, 
                    event.detail.xhr.statusText)
            }
        });
        function togglePanel() {
            const panel = document.querySelector('.left-panel');
            const isClosed = panel.classList.contains('closed');
            if (isClosed) {
                openPanel(panel);
                return;
            } 
            const isOpen = panel.classList.contains('open');
            if (isOpen) {
                closePanel(panel);
                return;
            }
            openPanel(panel);
        }
        function openPanel(panel) {
            openLeftPanel(panel);
            [...panel.children].forEach(element => {
                openLeftPanel(element);
                if (element.id === 'left-panel-toggle') {
                    element.innerHTML = '⇾  ⇽';
                }
            });
        }
        function closePanel(panel) {
            closeLeftPanel(panel);
            [...panel.children].forEach(element => {
                closeLeftPanel(element);
                if (element.id === 'left-panel-toggle') {
                    element.innerHTML = '⇽⇾';
                }
            });
        }
        function openLeftPanel(panel) {
            panel.classList.remove('closed');
            panel.classList.add('open');
        }
        function closeLeftPanel(panel) {
            panel.classList.remove('open');
            panel.classList.add('closed');
        }
    </script>
    <div class="left-panel 
        flex flex-col
        h-screen
        w-1/3
        p-2
        overflow-y-auto
        overflow-x-hidden
        border-2 border-zinc-600 rounded-lg
        shadow shadow-zinc-800">
        {{ if .IsAuthorized }}
            <div class="active-user 
                flex flex-row justify-between 
                p-2
                shadow">
                <div id="openSettingButton" 
                    title="open settings" 
                    hx-get="/settings" 
                    hx-trigger="click" 
                    hx-target=".open-chat" 
                    hx-swap="innerHTML"
                    class="bg-transparent text-xl hover:text-green-700"
                >
                    ⚙
                </div>
                <div class="flex">
                    <div class="font-bold">{{ .ActiveUser }}</div>
                    <form title="log out {{ .ActiveUser }}"
                        hx-post="/logout" 
                        hx-trigger="submit" 
                        hx-target="body"
                        class="other-info hover:text-red-700">
                        <button type="submit"><sub>[logout]</sub></button>
                    </form>
                </div>
            </div>
            <div class="add-chat flex w-full p-3">
                {{ template "addChatDiv" . }}
            </div>

            <div class="chat-list flex justify-between overflow-x-hidden">
                {{ template "chatListDiv" . }}
            </div>
            <button id="left-panel-toggle" onclick="togglePanel()" class="transition duration-100 mt-auto">
                <script>togglePanel()</script>
            </button>
        {{ else }}
            {{ template "login_div.html" .LoginTemplate }}
        {{ end }}
    </div>
    
    <div class="right-panel 
        flex flex-grow flex-col 
        h-screen 
        w-2/3 
        p-2
        border-2 border-zinc-700 rounded-lg
        shadow shadow-zinc-900">
        <div sse-swap="{{ .ChatCloseEvent }}"
            hx-swap="innerHTML"  
            class="open-chat">
            {{ if .IsAuthorized }}
                {{ with .OpenTemplate }}
                    {{ template "chat_div.html" . }}
                {{ else }}
                    {{ template "welcome_div.html" . }}
                {{ end }}
            {{ else }}
                {{ template "welcome_div.html" . }}
            {{ end }}
        </div>
    </div>
</body>
</html>

{{ define "addChatDiv" }}
<form id="add-chat-form"
    hx-post="/chat" 
    hx-trigger="submit" 
    hx-target=".open-chat" 
    hx-swap="innerHTML"
    class="w-full">
    <input id="newChatName" type="text" name="chatName" placeholder="new chat name" title="enter to send"
        class="w-full text-center rounded-md
            bg-gradient-to-br from-green-800 to-indigo-800
            text-gray-400
            shadow shadow-zinc-700
            hover:shadow-lg hover:shadow-zinc-500">
    <button type="submit" class="hidden">
        Create Chat
    </button>
</form>
<script>
    document.body.addEventListener('htmx:afterSwap', event => {
        const newChatName = document.getElementById('newChatName');
        if (newChatName) {
            newChatName.value = '';
        }
    });
</script>
{{ end }}

{{ define "chatListDiv" }}
<ul sse-swap="{{ .ChatAddEvent }}" 
    hx-swap="afterbegin" 
    class="chat-headers flex flex-col w-full py-2"> 
    {{ with $chats := .ReverseChats }}
        {{ range $index, $chat := $chats }} 
            {{ template "chat_li.html" $chat }}
        {{ end }}
    {{ else }}
        <li id="noChats" sse-swap="{{ .ChatAddEvent }}" hx-swap="delete" target="#noChats" 
            class="flex px-2 py-4">
            No chats yet
        </li>
    {{ end }}
</ul>
<script>
    function scrollToFirstChild(parent) {
        const firstElement = parent.children[0];
        firstElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
    chatHeaderObserver = null;
    chatHeaderObserver = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            if (mutation.type === 'childList' || mutation.type === 'characterData') {
                scrollToFirstChild(mutation.target);
            }
        });
    });
    chatHeaders = null;
    chatHeaders = document.querySelector(".chat-headers");
    if (chatHeaders) {
        chatHeaderObserverOptions = null;
        chatHeaderObserverOptions = { childList: true, subtree: true, characterData: true };
        chatHeaderObserver.observe(chatHeaders, chatHeaderObserverOptions);
    }
    scrollToFirstChild(chatHeaders);
</script>
{{ end }}