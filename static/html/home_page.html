<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
    {{ if .LoadLocal }}
    <script src="/script/htmx.1.9.10.min.js"></script>
    <script src="/script/htmx.1.9.10.sse.js"></script>
    <script src="/script/htmx.1.9.10.debug.js"></script>
    <script src="/script/tailwindcss.3.4.3.min.js"></script>
    <!-- Need to build tailwind to minimize -->
    <!-- <link href="/css/tailwind.css" rel="stylesheet"> -->
    {{ else }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.11/htmx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.11/ext/sse.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    {{ end }}
</head>
<body hx-ext="sse" sse-trigger="load" sse-connect="/poll"
    class="flex
        justify-between
        h-screen
        w-screen
        m-0 p-4 gap-4
        border-2 rounded-lg
        bg-gradient-to-br from-indigo-800 to-zinc-700
        text-gray-400
        shadow-md
        overflow-hidden">
    <div class="left-panel 
        flex flex-col
        p-2
        h-screen
        w-1/3
        overflow-y-auto
        overflow-x-hidden
        shadow-md">
        {{ if .IsAuthorized }}
            <div class="active-user flex flex-row justify-between p-2">
                <p class="font-bold">Active user: {{ .ActiveUser }}</p>
                <form 
                    hx-post="/logout" 
                    hx-trigger="submit" 
                    hx-target="body"
                    class="pl-2">
                    <button type="submit">[logout]</button>
                </form>
            </div> 
            <hr />
            {{ template "chatListDiv" . }}
            <hr />
            {{ template "addChatDiv" . }}
        {{ else }}
            {{ template "login_div.html" .LoginTemplate }}
        {{ end }}
    </div>
    
    <div class="right-panel 
        flex flex-col 
        p-2
        h-screen
        w-2/3
        shadow-md">
        {{ template "openChatDiv" . }}
    </div>
</body>
</html>

{{ define "chatListDiv" }}
<div class="chat-list p-2 h-3/4 overflow-auto">
    <ul sse-swap="{{ .ChatAddEvent }}" hx-swap="beforeend scroll:bottom show:top"
        class="chat-headers flex flex-col gap-y-2 last:b-0"> 
        {{ with $chats := .Chats }}
            {{ range $index, $chat := $chats }} 
                {{ template "chat_li.html" $chat }}
            {{ end }}
        {{ else }}
            <li id="noChats" sse-swap="{{ .ChatAddEvent }}" hx-swap="delete">
                No chats yet
            </li>
        {{ end }}
    </ul>
</div>
{{ end }}

{{ define "addChatDiv" }}
<div class="add-chat justify-between">
    <form id="add-chat-form"
        hx-post="/chat" 
        hx-trigger="submit" 
        hx-target=".open-chat" 
        hx-swap="innerHTML"
        class="flex flex-row 
            h-fit w-90 
            m-2 p-4 
            gap-4">
        <input id="newChatName" type="text" name="chatName" placeholder="new chat" 
            class="flex bg-gradient-to-br from-indigo-800 to-zinc-700
                text-gray-400
                shadow-md">
        <button type="submit" class="flex px-3 py-5">
            Create
        </button>
    </form>
    <script>
        document.body.addEventListener('htmx:afterSwap', event => {
            const newChatName = document.getElementById('newChatName');
            if (newChatName) {
                newChatName.value = '';
            }
        });
    </script>
</div>
{{ end }}

{{ define "openChatDiv" }}
<div class="open-chat p-2 flex flex-col">
    {{ if .IsAuthorized }}
        {{ with .OpenTemplate }}
            <div class="open-chat-content" 
                hx-get="/chat/{{ .ChatId }}" 
                hx-trigger="load"
                hx-target="this"
                hx-swap="innerHTML">
            </div>
        {{ else }}
            {{ template "welcome_div.html" . }}
        {{ end }}
    {{ else }}
        {{ template "welcome_div.html" . }}
    {{ end }}
</div>
{{ end }}