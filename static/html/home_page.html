<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
    {{ if .LoadLocal }}
    <script src="/script/htmx.1.9.10.min.js"></script>
    <script src="/script/htmx.1.9.10.sse.js"></script>
    <script src="/script/htmx.1.9.10.debug.js"></script>
    <script src="/script/tailwindcss.3.4.3.min.js"></script>
    <!-- Need to build tailwind to minimize it -->
    <!-- <link href="/css/tailwind.css" rel="stylesheet"> -->
    {{ else }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.11/htmx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.11/ext/sse.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    {{ end }}
</head>
<body 
    {{ if .IsAuthorized }}
        hx-ext="sse" sse-trigger="load" sse-connect="/poll"
    {{ end }}
    class="flex
        justify-between
        items-center
        h-screen
        w-screen
        border-2 border-zinc-800 rounded-lg
        bg-gradient-to-br from-indigo-800 to-zinc-700
        text-gray-400
        shadow-md
        overflow-hidden">
    <script>
        document.body.addEventListener('htmx:beforeOnLoad', function(event) {
            if (event.detail.xhr.status >= 400) {
                alert(`Action failed: ${event.detail.xhr.responseText}`)
                console.debug("Action failed:", 
                    event.detail.xhr.responseText, 
                    event.detail.xhr.status, 
                    event.detail.xhr.statusText)
            }
        });
    </script>
    <div class="left-panel 
        flex flex-col
        h-screen
        w-1/3
        p-2
        overflow-y-auto
        overflow-x-hidden
        border-2 border-zinc-600 rounded-lg
        shadow shadow-zinc-800">
        {{ if .IsAuthorized }}
            <div class="active-user 
                flex w-full justify-between 
                p-2
                shadow">
                <div class="font-bold">U-R: {{ .ActiveUser }}</div>
                <form title="log out {{ .ActiveUser }}"
                    hx-post="/logout" 
                    hx-trigger="submit" 
                    hx-target="body"
                    class="hover:text-orange-500">
                    <button type="submit">[logout]</button>
                </form>
            </div>
            <div class="add-chat flex w-full p-3">
                {{ template "addChatDiv" . }}
            </div>
            <div class="chat-list flex justify-between overflow-x-hidden">
                {{ template "chatListDiv" . }}
            </div>
        {{ else }}
            {{ template "login_div.html" .LoginTemplate }}
        {{ end }}
    </div>
    
    <div class="right-panel 
        flex flex-grow flex-col 
        h-screen 
        w-2/3 
        p-2
        border-2 border-zinc-700 rounded-lg
        shadow shadow-zinc-900">
        <div class="open-chat">
            {{ if .IsAuthorized }}
                {{ with .OpenTemplate }}
                    {{ template "chat_div.html" . }}
                {{ else }}
                    {{ template "welcome_div.html" . }}
                {{ end }}
            {{ else }}
                {{ template "welcome_div.html" . }}
            {{ end }}
        </div>
    </div>
    <script>
        document.body.addEventListener('htmx:beforeOnLoad', function(event) {
            if (event.detail.xhr.status >= 400) {  // Check for HTTP error codes (400+)
                // Handle error, e.g., show a message, log, etc.
                console.error("Error loading data: ", event.detail.xhr.responseText);
            }
        });
    </script>
</body>
</html>

{{ define "addChatDiv" }}
<form id="add-chat-form"
    hx-post="/chat" 
    hx-trigger="submit" 
    hx-target=".open-chat" 
    hx-swap="innerHTML"
    hx-ext="debug"
    class="w-full">
    <input id="newChatName" type="text" name="chatName" placeholder="open new chat" 
        class="w-full text-center rounded-md
            bg-gradient-to-br from-indigo-800 to-zinc-700
            text-gray-400">
    <button type="submit" class="hidden">
        Create
    </button>
</form>
<script>
    document.body.addEventListener('htmx:afterSwap', event => {
        const newChatName = document.getElementById('newChatName');
        if (newChatName) {
            newChatName.value = '';
        }
    });
</script>
{{ end }}

{{ define "chatListDiv" }}
<ul sse-swap="{{ .ChatAddEvent }}" 
    hx-swap="afterbegin" 
    class="chat-headers flex flex-col w-full py-2"> 
    {{ with $chats := .ReverseChats }}
        {{ range $index, $chat := $chats }} 
            {{ template "chat_li.html" $chat }}
        {{ end }}
    {{ else }}
        <li id="noChats" sse-swap="{{ .ChatAddEvent }}" hx-swap="delete" target="#noChats" 
            class="flex px-2 py-4">
            No chats yet
        </li>
    {{ end }}
</ul>
{{ end }}